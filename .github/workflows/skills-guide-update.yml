name: Skills Guide Auto-Update

# 30ì¼ë§ˆë‹¤ ìžë™ ì‹¤í–‰ + ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
on:
  schedule:
    # ë§¤ì›” 1ì¼ê³¼ 15ì¼ ì˜¤ì „ 9ì‹œ (KST ê¸°ì¤€ 18ì‹œ)ì— ì‹¤í–‰
    - cron: '0 9 1,15 * *'

  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      force:
        description: 'ê°•ì œ ì—…ë°ì´íŠ¸ (30ì¼ ëŒ€ê¸° ë¬´ì‹œ)'
        required: false
        default: 'false'

jobs:
  update-skills-guide:
    runs-on: ubuntu-latest

    permissions:
      contents: write # íŒŒì¼ ìˆ˜ì • ë° ì»¤ë°‹ ê¶Œí•œ

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run Skills Guide Updater
        run: |
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            npx ts-node scripts/skillsGuideUpdater.ts --force
          else
            npx ts-node scripts/skillsGuideUpdater.ts
          fi

      - name: ðŸ“Š Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add "skills guide/"
          git add scripts/

          # ë³€ê²½ëœ íŒŒì¼ ìˆ˜ ê³„ì‚°
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)

          git commit -m "docs: auto-update skills guide (${CHANGED_FILES} files)

          ðŸ¤– Automated update performed by Skills Guide Updater

          - Updated version information
          - Checked for deprecated packages
          - Generated update report

          Next update: $(date -d '+30 days' '+%Y-%m-%d')"

          git push

      - name: ðŸ“ Create Summary
        if: always()
        run: |
          echo "## ðŸ“Š Skills Guide Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "skills guide/LIVEMETRO_UPDATE_REPORT.md" ]; then
            cat "skills guide/LIVEMETRO_UPDATE_REPORT.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No updates were necessary at this time." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš¨ Notify on failure
        if: failure()
        run: |
          echo "::error::Skills Guide update failed! Please check the logs."
